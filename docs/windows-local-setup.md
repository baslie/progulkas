# Руководство по запуску «Маршруты Прогулки» на Windows

Это руководство описывает полный цикл подготовки и запуска проекта «Маршруты Прогулки» на локальном компьютере под управлением Windows 10/11. Документ охватывает два сценария:

1. **WSL 2 (рекомендуется)** — максимальная совместимость с Linux-окружением и Docker.
2. **Нативный Windows** — запуск без WSL, при наличии установленного Node.js и PostgreSQL.

Используйте те шаги, которые соответствуют выбранному сценарию. Обе инструкции приводят к доступности дев-сервера по адресу <http://localhost:3000>.

---

## 1. Требования

### 1.1 Общие
- Windows 10 22H2 или Windows 11 23H2 и выше.
- Права администратора для установки компонентов.
- Доступ к интернету для загрузки зависимостей.

### 1.2 ПО для сценария с WSL 2 (рекомендуется)
- [Windows Subsystem for Linux 2](https://learn.microsoft.com/windows/wsl/install) с дистрибутивом Ubuntu 22.04 LTS.
- [Docker Desktop для Windows](https://www.docker.com/products/docker-desktop/), включите интеграцию с WSL 2.
- Node.js и npm ставятся внутри WSL (через `nvm` или официальный репозиторий).

### 1.3 ПО для нативного сценария
- [Node.js 20 LTS](https://nodejs.org/en/download) (инсталлятор `.msi` добавляет npm автоматически).
- [PostgreSQL 16](https://www.postgresql.org/download/windows/) с графическим установщиком (PgAdmin опционально).
- [Git для Windows](https://git-scm.com/download/win) либо Git из пакета `winget install Git.Git`.
- (Опционально) [Docker Desktop] для запуска в контейнерах без ручной установки PostgreSQL.

---

## 2. Подготовка репозитория

1. Откройте PowerShell (или терминал WSL) и перейдите в каталог, где хотите хранить проект.
2. Клонируйте репозиторий:
   ```powershell
   git clone https://github.com/<ваш-аккаунт>/progulkas.git
   cd progulkas
   ```
3. Проверьте наличие файла `.env.example`. Скопируйте его в `.env`:
   ```bash
   cp .env.example .env
   ```
   Заполните переменные окружения (секреты OAuth, URL базы данных и SMTP), используя предпочитаемый редактор.

> **Совет:** для нативного Windows используйте редактор, который корректно работает с Unix-окончаниями строк (VS Code, Notepad++).

---

## 3. Сценарий с WSL 2 и Docker (рекомендуется)

### 3.1 Установка зависимостей внутри WSL
```bash
# Обновите пакеты Ubuntu
sudo apt update && sudo apt upgrade -y

# Установите build-инструменты и зависимости для Node.js/Prisma
sudo apt install -y build-essential openssl libssl-dev

# Установите nvm и Node.js 20
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
source ~/.nvm/nvm.sh
nvm install 20
nvm use 20
```

### 3.2 Запуск через Docker Compose
1. Убедитесь, что Docker Desktop запущен и интеграция с вашим WSL-дистрибутивом включена.
2. В корне проекта выполните:
   ```bash
   docker compose up --build
   ```
3. Docker скачает образ PostgreSQL, соберёт образ Next.js и запустит дев-сервер. Первое развёртывание может занять 5–10 минут.
4. После успешного старта откройте <http://localhost:3000> в браузере Windows.
5. Для остановки используйте `Ctrl+C` в терминале или команду `docker compose down` в отдельном окне.

### 3.3 Выполнение миграций вручную (при необходимости)
Если вы хотите применить миграции напрямую, подключитесь к контейнеру `web`:
```bash
docker compose exec web bash
npm run prisma:generate
npx prisma migrate deploy
```
Затем выйдите из контейнера (`exit`).

---

## 4. Сценарий без WSL (нативный Windows)

### 4.1 Установка Node.js и PostgreSQL
1. Установите Node.js 20 LTS через официальный инсталлятор. Убедитесь, что галочка "Add to PATH" активна.
2. Установите PostgreSQL 16 и запомните пароль пользователя `postgres`. При первом запуске создайте базу данных `progulkas_dev` (можно через PgAdmin или командой `createdb`).

### 4.2 Настройка переменных окружения
В файле `.env` убедитесь, что строка подключения `DATABASE_URL` ссылается на локальный сервер, например:
```
DATABASE_URL="postgresql://postgres:<ваш_пароль>@localhost:5432/progulkas_dev?schema=public"
```
Дополнительно задайте SMTP- и OAuth-переменные, если планируете тестировать эти интеграции.

### 4.3 Установка npm-зависимостей и миграций
Откройте PowerShell или Windows Terminal:
```powershell
npm install
npm run prisma:generate
npx prisma migrate deploy
```

### 4.4 Запуск дев-сервера
```powershell
npm run dev
```
Сервер будет доступен по адресу <http://localhost:3000>. Для остановки нажмите `Ctrl+C`.

> **Примечание:** Если порты 3000 (Next.js) или 5432 (PostgreSQL) заняты, измените их в `.env` и настройках PostgreSQL.

---

## 5. Дополнительные операции

### 5.1 Проверка качества кода
Перед коммитом на любой платформе рекомендуется запускать:
```bash
npm run lint
npm run typecheck
```

### 5.2 Сброс базы данных
Для повторной инициализации схемы используйте:
```bash
npx prisma migrate reset
```
Команда удалит данные, применит миграции и запустит сиды (если настроены).

### 5.3 Обновление зависимостей
Используйте `npm update` или целевые команды `npm install <package>@latest`. После обновления пересоберите проект (`npm run build`) и перезапустите сервер.

---

## 6. Типичные проблемы и решения

| Проблема | Причина | Решение |
| --- | --- | --- |
| `Error: P1001` при подключении Prisma | PostgreSQL недоступен | Проверьте, что сервис запущен и строка `DATABASE_URL` верна. Для Docker проверьте `docker compose ps`. |
| Конфликт портов | Порты 3000/5432 заняты | Измените порты в `.env` и настройках PostgreSQL или остановите конфликтующие приложения. |
| `node: command not found` в WSL | nvm не загружен | Выполните `source ~/.nvm/nvm.sh` или добавьте его в `~/.bashrc`. |
| npm завис на `husky install` | Отсутствует Git | Убедитесь, что Git установлен и доступен в PATH. |

---

## 7. Проверка работоспособности

После старта сервера откройте <http://localhost:3000>. Должна отобразиться главная страница каталога маршрутов. Для теста аутентификации зарегистрируйте нового пользователя — письма активации выводятся в логах сервера в dev-режиме.

---

## 8. Полезные ссылки
- [Официальный README проекта](../README.md) — содержит команды и описание архитектуры.
- [Документация Next.js App Router](https://nextjs.org/docs/app).
- [Документация Prisma](https://www.prisma.io/docs).
- [Руководство по NextAuth.js](https://next-auth.js.org/).

---

Если при выполнении шагов возникают трудности, фиксируйте сообщения об ошибках и обращайтесь к логам Docker или PostgreSQL — это ускорит диагностику.
